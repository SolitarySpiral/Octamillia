# Архитектура Octamillia

Статус: В разработке
---
Цель: Абсолютная абстракция, объединение архитектур.
Мозг - Тело - Щупальца

Мозг(brain) состоит из: WAI, brain, models, external_client.
WAI - геном Октамиллиа.
brain - мозг архитектуры, оживляет приложение, ищет тентакли, координирует их инициализацию.
models - хранит универсальный ответ архитектуры.

Тело(body) состоит из body.

Тентакли(tentacles) состоят из директории с реализацией тентакли и её моделью данных
Каждая тентакля создается с использованием следующих классов архитектуры Octamillia
```python
from app.brain import (
    CommandContext,
    CommandDispatchTentacle,
    OctaResponse,
    TentacleContract,
    TentacleMetadata,
)
```
Тентакля работает со своей моделью данных(Payload)
from .models import ConfigPayload

Тентакля исполняет контракт архитектуры щупальца.
class ConfigLoaderStandinTentacle(TentacleContract):

Суть контракта:
```python
_COMMAND_HANDLERS = {
        "LOAD_CONFIG": "_load_config",  # Обратите внимание: сохраняем только имя метода
        # ... и так далее
    }
```
Используется Паттерн Диспетчер Команд (Command Dispatcher)
process_command выполняет логику маршрутизации в словарь-диспетчер (Dictionary Dispatch).
Возвращает fail если команда такая отсутствует в словаре.
Каждая команда становится отдельным, маленьким, легко тестируемым методом с единственной ответственностью.

Метод get_capabilities(self) -> List[str] должен возвращать список доступных команд, которыми оперирует process_command.
Он выглядит только так
```python
@classmethod
def get_capabilities(cls) -> List[str]:
    """Метод, который сообщает Мозгу: 'Я умею делать X, Y, Z'."""
    return list(cls._COMMAND_HANDLERS.keys())
```
Метод ```get_health(self) -> float``` возвращает жизнь тентакли.

---
# Принципы SOLID
SOLID — это акроним, представляющий собой пять основных принципов объектно-ориентированного программирования и проектирования, направленных на создание гибких, поддерживаемых и масштабируемых систем.

S - Single Responsibility Principle (Принцип Единственной Ответственности)
Сущность должна иметь только одну причину для изменения.

Значение: Каждый класс, модуль или функция должен решать только одну задачу.

В Octamillia:

Brain отвечает только за маршрутизацию и реконсиляцию (Control Plane).

TentacleContract отвечает только за контракт взаимодействия.

Локальные Payload модели (VideoPayload, ConfigPayload) отвечают только за структуру данных своего домена.

O - Open/Closed Principle (Принцип Открытости/Закрытости)
Сущности должны быть открыты для расширения, но закрыты для модификации.

Значение: Вы должны иметь возможность добавлять новый функционал, не меняя существующий, протестированный код.

В Octamillia: Чтобы добавить новое щупальце (AudioSync), вам не нужно изменять ядро (Brain, WAI, models.py). Вы просто создаете новый файл с TentacleMetadata и новой логикой, который регистрируется в системе.

L - Liskov Substitution Principle (Принцип Подстановки Барбары Лисков)
Объекты в программе должны быть заменены экземплярами их подтипов без изменения правильности выполнения программы.

Значение: Наследник должен полностью соответствовать поведению родителя. Если B наследуется от A, то везде, где используется A, можно без проблем использовать B.

В Octamillia: Любой класс, наследующий TentacleContract (например, ConfigLoaderStandinTentacle), может быть передан в Brain.route_command, и Мозг будет знать, как с ним работать, используя только методы process_command, get_health и т.д.

I - Interface Segregation Principle (Принцип Разделения Интерфейса)
Клиенты не должны зависеть от интерфейсов, которые они не используют.

Значение: Лучше иметь много мелких, специализированных интерфейсов, чем один большой, "жирный".

В Octamillia: Контракт TentacleContract содержит минимально необходимый набор методов (process_command, get_health, get_capabilities). Если бы мы добавили туда методы, нужные только для работы с БД, другие щупальца, не использующие БД, были бы вынуждены их реализовывать.

D - Dependency Inversion Principle (Принцип Инверсии Зависимостей)
Модули высокого уровня не должны зависеть от модулей низкого уровня. Оба должны зависеть от абстракций.

Значение: Вместо того чтобы Мозг (высокий уровень) напрямую вызывал конкретный класс (VideoSyncStandinTentacle — низкий уровень), они оба зависят от абстракции (TentacleContract).

В Octamillia: Мозг не знает, как VideoSync выполняет команду (с помощью yt-dlp или другим способом); он знает только, что щупальце контрактно обязано выполнить process_command. Это обеспечивает слабую связанность.


Паттерн	Описание	Реализация в Octamillia
Ports and Adapters (Hexagonal Architecture)	
Структурный паттерн, который изолирует ядро приложения от внешнего мира через абстрактные порты (интерфейсы).	
TentacleContract (Порт) — это базовый контракт, а CommandDispatchTentacle (Адаптер) — это конкретная реализация контракта через архитектуру Octamillia.

class ConfigLoaderStandinTentacle(CommandDispatchTentacle) реализует конкретную логику, не смотрит на начинку архитектуры.

Command	
Поведенческий паттерн, который инкапсулирует запрос как объект, позволяя параметризовать клиентов различными запросами.	
Объект CommandContext инкапсулирует команду (command_name), параметры (params) и метаданные для передачи по системе.

Service Locator / Registry	
Структурный паттерн, который централизует информацию о доступных сервисах.	
WAI_REGISTRY и Brain.registry — это централизованный реестр, где регистрируются все TentacleMetadata.

Strategy	
Поведенческий паттерн, который определяет семейство алгоритмов, инкапсулирует каждый из них и делает их взаимозаменяемыми.	
Brain.route_command использует стратегию Failover/Round Robin для выбора, какое щупальце будет выполнять команду.

Circuit Breaker (Автоматический Выключатель)	
Паттерн отказоустойчивости, который предотвращает каскадные отказы, быстро прерывая вызов к отказавшему сервису.	
config_breaker (в ConfigLoaderStandinTentacle) защищает Standin от перегрузки, мгновенно прерывая выполнение при многочисленных сбоях.

Round Robin	
Алгоритм балансировки нагрузки, который циклически распределяет запросы между доступными серверами.	
Реализация в Brain.route_command через self.last_used_index для равномерного распределения трафика между здоровыми внешними щупальцами.

Generic Repository	
Концепция универсального, типизированного контейнера для данных.	
Класс OctaResponse[DataT] действует как универсальный "конверт", который может содержать любую типизированную полезную нагрузку (DataT), не зная её структуры заранее.
